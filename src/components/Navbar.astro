---
import type { Locale } from "../i18n/i18n";
import { t, getLocalizedPath } from "../i18n/i18n";

interface Props {
  locale: Locale;
}

const { locale } = Astro.props;
const i = t(locale);
const altLocale = locale === "en" ? "id" : "en";
---

<!-- Desktop/Tablet Top Navbar -->
<nav
  id="navbar"
  class="fixed top-0 left-0 right-0 z-50 transition-all duration-500 hidden md:block"
>
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="flex items-center justify-between h-20">
      <!-- Logo -->
      <a href={getLocalizedPath(locale)} class="flex items-center gap-3 group">
        <div
          class="w-10 h-10 rounded-xl bg-gradient-to-br from-primary-500 to-accent-500 flex items-center justify-center shadow-lg shadow-primary-500/25 group-hover:shadow-primary-500/50 transition-all duration-300 group-hover:scale-105"
        >
          <svg
            class="w-6 h-6 text-white"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
            stroke-width="2"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="M8.111 16.404a5.5 5.5 0 017.778 0M12 20h.01m-7.08-7.071c3.904-3.905 10.236-3.905 14.141 0M1.394 9.393c5.857-5.858 15.355-5.858 21.213 0"
            ></path>
          </svg>
        </div>
        <span class="text-xl font-bold text-surface-900 dark:text-white"
          >HM<span class="gradient-text">Mobile</span>
        </span>
      </a>

      <!-- Desktop Nav Links -->
      <div class="flex items-center gap-1">
        <a
          href={`${getLocalizedPath(locale)}#features`}
          class="nav-link"
          data-section="features"
          >{i.nav.features}
        </a>
        <a
          href={`${getLocalizedPath(locale)}#devices`}
          class="nav-link"
          data-section="devices"
          >{i.nav.devices}
        </a>
        <a
          href={`${getLocalizedPath(locale)}#download`}
          class="nav-link"
          data-section="download"
          >{i.nav.download}
        </a>
        <a
          href={`${getLocalizedPath(locale)}#faq`}
          class="nav-link"
          data-section="faq"
          >{i.nav.faq}
        </a>
        <a
          href="https://github.com/alrescha79-cmd/huawei-manager-mobile"
          target="_blank"
          rel="noopener noreferrer"
          class="nav-link"
        >
          {i.nav.github}
        </a>
      </div>

      <!-- Actions -->
      <div class="flex items-center gap-2">
        <!-- Language Switcher -->
        <a
          href={getLocalizedPath(altLocale)}
          class="lang-toggle group"
          data-base-href={getLocalizedPath(altLocale)}
        >
          <span
            class="lang-toggle-option"
            data-active={locale === "en" ? "true" : "false"}>EN</span
          >
          <span
            class="lang-toggle-option"
            data-active={locale === "id" ? "true" : "false"}>ID</span
          >
        </a>

        <!-- Theme Toggle -->
        <button
          id="theme-toggle"
          type="button"
          aria-label="Toggle theme"
          class="theme-toggle-btn"
        >
          <div class="theme-toggle-track">
            <svg
              class="theme-icon sun-icon"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
              stroke-width="2"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"
              ></path>
            </svg>
            <svg
              class="theme-icon moon-icon"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
              stroke-width="2"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"
              ></path>
            </svg>
            <div class="theme-toggle-thumb"></div>
          </div>
        </button>
      </div>
    </div>
  </div>
</nav>

<!-- Mobile Bottom Navigation Bar -->
<nav
  id="mobile-bottom-nav"
  class="md:hidden fixed bottom-6 left-1/2 -translate-x-1/2 z-50 w-[92%] max-w-md overflow-hidden bg-white/70 dark:bg-surface-950/80 backdrop-blur-2xl border border-surface-200/50 dark:border-white/10 rounded-4xl shadow-xl shadow-surface-950/10 dark:shadow-2xl dark:shadow-black/60"
>
  <div class="relative grid grid-cols-4 items-center h-16 px-2">
    <!-- Active indicator pill background -->
    <div
      id="mobile-nav-indicator"
      class="absolute inset-y-2 bg-cyan-400 dark:bg-cyan-500 rounded-full transition-all duration-500 ease-[cubic-bezier(0.34,1.56,0.64,1)] z-0 shadow-[0_0_20px_rgba(34,211,238,0.4)]"
      style="left: 0; width: 0; opacity: 0;"
    >
    </div>

    <a
      href={`${getLocalizedPath(locale)}#features`}
      class="mobile-nav-item relative z-10"
      data-section="features"
    >
      <svg
        xmlns="http://www.w3.org/2000/svg"
        class="w-6 h-6 mb-0.5"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
        stroke-linecap="round"
        stroke-linejoin="round"
      >
        <rect x="3" y="3" width="7" height="7" rx="1.5"></rect>
        <rect x="14" y="3" width="7" height="7" rx="1.5"></rect>
        <rect x="14" y="14" width="7" height="7" rx="1.5"></rect>
        <rect x="3" y="14" width="7" height="7" rx="1.5"></rect>
      </svg>
      <span>{i.nav.features}</span>
    </a>

    <a
      href={`${getLocalizedPath(locale)}#devices`}
      class="mobile-nav-item relative z-10"
      data-section="devices"
    >
      <svg
        xmlns="http://www.w3.org/2000/svg"
        class="w-6 h-6 mb-0.5"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
        stroke-linecap="round"
        stroke-linejoin="round"
      >
        <rect x="2" y="14" width="20" height="8" rx="2"></rect>
        <path d="M6 18h.01"></path>
        <path d="M10 18h.01"></path>
        <path d="M12 2v12"></path>
      </svg>
      <span>{i.nav.devices}</span>
    </a>
    <a
      href={`${getLocalizedPath(locale)}#download`}
      class="mobile-nav-item relative z-10"
      data-section="download"
    >
      <svg
        class="w-5 h-5"
        fill="none"
        viewBox="0 0 24 24"
        stroke="currentColor"
        stroke-width="2.5"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"
        ></path>
      </svg>
      <span>{i.nav.download}</span>
    </a>
    <a
      href={`${getLocalizedPath(locale)}#faq`}
      class="mobile-nav-item relative z-10"
      data-section="faq"
    >
      <svg
        class="w-5 h-5"
        fill="none"
        viewBox="0 0 24 24"
        stroke="currentColor"
        stroke-width="2.5"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
        ></path>
      </svg>
      <span>{i.nav.faq}</span>
    </a>
  </div>
</nav>

<!-- Mobile Top Bar (logo only) -->
<div
  class="md:hidden fixed top-0 left-0 right-0 z-50 transition-all duration-500"
  id="mobile-top-bar"
>
  <div class="px-4 h-14 flex items-center justify-between">
    <a href={getLocalizedPath(locale)} class="flex items-center gap-2 group">
      <div
        class="w-8 h-8 rounded-lg bg-gradient-to-br from-primary-500 to-accent-500 flex items-center justify-center shadow-md"
      >
        <svg
          class="w-4 h-4 text-white"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor"
          stroke-width="2"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            d="M8.111 16.404a5.5 5.5 0 017.778 0M12 20h.01m-7.08-7.071c3.904-3.905 10.236-3.905 14.141 0M1.394 9.393c5.857-5.858 15.355-5.858 21.213 0"
          ></path>
        </svg>
      </div>
      <span class="text-base font-bold text-surface-900 dark:text-white"
        >HM<span class="gradient-text">Mobile</span>
      </span>
    </a>

    <!-- Language & Theme (same style as desktop) -->
    <div class="flex items-center gap-2">
      <a
        href={getLocalizedPath(altLocale)}
        class="lang-toggle group"
        data-base-href={getLocalizedPath(altLocale)}
      >
        <span
          class="lang-toggle-option"
          data-active={locale === "en" ? "true" : "false"}>EN</span
        >
        <span
          class="lang-toggle-option"
          data-active={locale === "id" ? "true" : "false"}>ID</span
        >
      </a>

      <button
        id="theme-toggle-mobile"
        type="button"
        aria-label="Toggle theme"
        class="theme-toggle-btn"
      >
        <div class="theme-toggle-track">
          <svg
            class="theme-icon sun-icon"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
            stroke-width="2"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"
            ></path>
          </svg>
          <svg
            class="theme-icon moon-icon"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
            stroke-width="2"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"
            ></path>
          </svg>
          <div class="theme-toggle-thumb"></div>
        </div>
      </button>
    </div>
  </div>
</div>

<script is:inline>
  function toggleTheme() {
    var html = document.documentElement;
    if (html.classList.contains("dark")) {
      html.classList.remove("dark");
      localStorage.setItem("theme", "light");
    } else {
      html.classList.add("dark");
      localStorage.setItem("theme", "dark");
    }
  }

  document
    .getElementById("theme-toggle")
    ?.addEventListener("click", toggleTheme);
  document
    .getElementById("theme-toggle-mobile")
    ?.addEventListener("click", toggleTheme);

  // Navbar background on scroll (desktop)
  window.addEventListener("scroll", function () {
    var navbar = document.getElementById("navbar");
    var mobileTop = document.getElementById("mobile-top-bar");
    if (navbar) {
      if (window.scrollY > 20) {
        navbar.classList.add("nav-scrolled");
      } else {
        navbar.classList.remove("nav-scrolled");
      }
    }
    if (mobileTop) {
      if (window.scrollY > 20) {
        mobileTop.classList.add("nav-scrolled");
      } else {
        mobileTop.classList.remove("nav-scrolled");
      }
    }
  });

  // Scroll-spy: highlight active section in nav
  var sectionIds = ["features", "devices", "download", "faq"];
  var currentActive = "";

  function setActiveSection(sectionId) {
    if (sectionId === currentActive) return;
    currentActive = sectionId;

    // Desktop nav links
    document
      .querySelectorAll(".nav-link[data-section]")
      .forEach(function (link) {
        if (link.dataset.section === sectionId) {
          link.classList.add("nav-link-active");
        } else {
          link.classList.remove("nav-link-active");
        }
      });

    // Mobile nav items
    var mobileItems = document.querySelectorAll(
      ".mobile-nav-item[data-section]"
    );
    var indicator = document.getElementById("mobile-nav-indicator");

    mobileItems.forEach(function (item) {
      if (item.dataset.section === sectionId) {
        item.classList.add("mobile-nav-active");
        if (indicator) {
          indicator.style.opacity = "1";
          const padding = 8;
          indicator.style.left = item.offsetLeft + padding + "px";
          indicator.style.width = item.offsetWidth - padding * 2 + "px";
        }
      } else {
        item.classList.remove("mobile-nav-active");
      }
    });
  }

  var observer = new IntersectionObserver(
    function (entries) {
      entries.forEach(function (entry) {
        if (entry.isIntersecting) {
          setActiveSection(entry.target.id);
        }
      });
    },
    { rootMargin: "-20% 0px -60% 0px", threshold: 0 }
  );

  sectionIds.forEach(function (id) {
    var section = document.getElementById(id);
    if (section) observer.observe(section);
  });

  // Handle language switch with hash preservation
  document.querySelectorAll(".lang-toggle").forEach(function (link) {
    link.addEventListener("click", function (e) {
      e.preventDefault();
      const baseHref = link.dataset.baseHref;
      if (!baseHref) return;

      // Use currentActive from scroll-spy, or find most visible section manually
      let targetHash = currentActive;

      if (!targetHash) {
        // Fallback: Check which section is most visible in the viewport
        let maxVisible = -1;
        sectionIds.forEach(function (id) {
          const el = document.getElementById(id);
          if (el) {
            const rect = el.getBoundingClientRect();
            const visibleHeight =
              Math.min(rect.bottom, window.innerHeight) - Math.max(rect.top, 0);
            if (visibleHeight > maxVisible) {
              maxVisible = visibleHeight;
              targetHash = id;
            }
          }
        });
      }

      const finalHash = targetHash ? `#${targetHash}` : "";
      window.location.href = baseHref + finalHash;
    });
  });

  // Clear active state when at top of page (hero section)
  window.addEventListener("scroll", function () {
    if (window.scrollY < 200) {
      currentActive = "";
      document
        .querySelectorAll(".nav-link[data-section]")
        .forEach(function (l) {
          l.classList.remove("nav-link-active");
        });
      document
        .querySelectorAll(".mobile-nav-item[data-section]")
        .forEach(function (i) {
          i.classList.remove("mobile-nav-active");
        });
      var ind = document.getElementById("mobile-nav-indicator");
      if (ind) ind.style.opacity = "0";
    }
  });
</script>

<style>
  .safe-area-bottom {
    padding-bottom: env(safe-area-inset-bottom, 0px);
  }
</style>
