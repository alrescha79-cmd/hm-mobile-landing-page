---
import type { Locale } from '../i18n/i18n';
import { t } from '../i18n/i18n';

interface Props {
  locale: Locale;
}

const { locale } = Astro.props;
const i = t(locale);

const REPO = 'alrescha79-cmd/huawei-manager-mobile';

let releaseData: { tag: string; assets: { name: string; url: string; size: number }[] } = {
  tag: 'latest',
  assets: [],
};

try {
  const res = await fetch(`https://api.github.com/repos/${REPO}/releases/latest`);
  if (res.ok) {
    const data = await res.json();
    releaseData = {
      tag: data.tag_name || 'latest',
      assets: (data.assets || []).map((a: any) => ({
        name: a.name,
        url: a.browser_download_url,
        size: a.size,
      })),
    };
  }
} catch {
  // Fallback to static URLs
}

function getAssetUrl(pattern: string): string {
  const asset = releaseData.assets.find(a => a.name.includes(pattern));
  return asset?.url || `https://github.com/${REPO}/releases/latest/download/huawei-manager-${pattern}.apk`;
}

function formatSize(bytes: number): string {
  if (!bytes) return '';
  return `${(bytes / (1024 * 1024)).toFixed(0)} MB`;
}

function getAssetSize(pattern: string): string {
  const asset = releaseData.assets.find(a => a.name.includes(pattern));
  return asset ? formatSize(asset.size) : '';
}

const downloads = [
  {
    key: 'arm64' as const,
    pattern: 'arm64-v8a',
    icon: 'üöÄ',
    gradient: 'from-primary-500 to-primary-600',
    ring: 'ring-primary-500/20',
  },
  {
    key: 'armv7' as const,
    pattern: 'armeabi-v7a',
    icon: 'üì¶',
    gradient: 'from-accent-500 to-accent-600',
    ring: 'ring-accent-500/20',
  },
  {
    key: 'universal' as const,
    pattern: 'universal',
    icon: 'üåê',
    gradient: 'from-purple-500 to-violet-600',
    ring: 'ring-purple-500/20',
  },
];
---

<section id="download" class="py-20 sm:py-32 relative">
  <div class="absolute inset-0 -z-10">
    <div class="absolute top-0 inset-x-0 h-px bg-gradient-to-r from-transparent via-surface-200 dark:via-surface-800 to-transparent"></div>
    <div class="absolute top-1/2 right-0 w-96 h-96 bg-primary-500/5 rounded-full blur-3xl"></div>
    <div class="absolute bottom-0 left-1/3 w-96 h-96 bg-accent-500/5 rounded-full blur-3xl"></div>
  </div>

  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="text-center max-w-3xl mx-auto mb-16">
      <h2 class="text-3xl sm:text-4xl lg:text-5xl font-extrabold tracking-tight">
        <span class="gradient-text">{i.download.sectionTitle}</span>
      </h2>
      <p class="mt-4 text-lg text-surface-600 dark:text-surface-400">
        {i.download.sectionDescription}
      </p>
      {releaseData.tag !== 'latest' && (
        <p class="mt-2 text-sm text-surface-500">
          {i.download.version}: <span class="font-mono font-semibold text-primary-500">{releaseData.tag}</span>
        </p>
      )}
    </div>

    <!-- Download cards -->
    <div class="grid sm:grid-cols-3 gap-6 max-w-5xl mx-auto">
      {downloads.map((dl, idx) => {
        const dlData = i.download[dl.key];
        const url = getAssetUrl(dl.pattern);
        const size = getAssetSize(dl.pattern);
        return (
          <div class={`glass-card p-6 sm:p-8 text-center hover:shadow-xl transition-all duration-300 hover:-translate-y-2 animate-fade-up stagger-${idx + 1} relative overflow-hidden group`}>
            {idx === 0 && (
              <div class="absolute top-4 right-4">
                <span class="px-2.5 py-1 text-xs font-bold rounded-full bg-green-500/15 text-green-600 dark:text-green-400 border border-green-500/20">
                  ‚úì {dlData.badge}
                </span>
              </div>
            )}
            {idx > 0 && (
              <div class="absolute top-4 right-4">
                <span class="px-2.5 py-1 text-xs font-medium rounded-full bg-surface-100 dark:bg-surface-700 text-surface-600 dark:text-surface-400">
                  {dlData.badge}
                </span>
              </div>
            )}

            <div class="text-4xl mb-4">{dl.icon}</div>
            <h3 class="text-xl font-bold text-surface-900 dark:text-white mb-2">{dlData.title}</h3>
            <p class="text-sm text-surface-600 dark:text-surface-400 mb-6 leading-relaxed min-h-[3rem]">{dlData.description}</p>

            {size && <p class="text-xs text-surface-500 mb-4 font-mono">{size}</p>}

            <a
              href={url}
              class={`inline-flex items-center justify-center gap-2 w-full px-6 py-3 text-sm font-semibold text-white bg-gradient-to-r ${dl.gradient} rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 hover:-translate-y-0.5 ring-1 ${dl.ring}`}
            >
              <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
              </svg>
              {i.download.downloadBtn}
            </a>
          </div>
        );
      })}
    </div>

    <!-- Install guide -->
    <div class="mt-16 max-w-2xl mx-auto">
      <div class="glass-card p-6 sm:p-8">
        <h3 class="text-lg font-bold text-surface-900 dark:text-white mb-4 flex items-center gap-2">
          <svg class="w-5 h-5 text-primary-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          {i.download.installGuide.title}
        </h3>
        <ol class="space-y-3">
          {i.download.installGuide.steps.map((step: string, idx: number) => (
            <li class="flex items-start gap-3 text-sm text-surface-600 dark:text-surface-400">
              <span class="flex-shrink-0 w-6 h-6 rounded-full bg-primary-500/15 text-primary-600 dark:text-primary-400 text-xs font-bold flex items-center justify-center mt-0.5">
                {idx + 1}
              </span>
              <span>{step}</span>
            </li>
          ))}
        </ol>
      </div>
    </div>
  </div>
</section>
